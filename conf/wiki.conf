proxy_cookie_domain  ~(?<subcookie>(advisors(?:\.m)?|advisory(?:\.m)?|affcom|am(?:\.m)?|analytics|annual|api(?:\.m)?|ar(?:\.m)?|auditcom|bd(?:\.m)?|be(?:\.m)?|blog|board|boardgovcom|br(?:\.m)?|bugzilla|ca(?:\.m)?|chair|checkuser(?:\.m)?|cn(?:\.m)?|co(?:\.m)?|collab|(?:test-)?commons(?:\.m)?|config-master|cxserver|dbtree|design|developer|diff|dk(?:\.m)?|doc|ec(?:\.m)?|ee(?:\.m)?|electcom(?:\.m)?|etherpad|exec(?:\.m)?|fdc(?:\.m)?|fi(?:\.m)?|foundation(?:\.m)?|ge(?:\.m)?|gerrit|github|gr(?:\.m)?|grafana|grants(?:\.m)?|graphite|hi(?:\.m)?|horizon|id(?:\.m)?|id-internal(?:\.m)?|idp|iegcom(?:\.m)?|il|incubator(?:\.m)?|integration|internal|labtestwikitech|legalteam(?:\.m)?|lists|login(?:\.m)?|logstash|mai(?:\.m)?|maps|meta(?:\.m)?|mk(?:\.m)?|movementroles|mx(?:\.m)?|ng(?:\.m)?|nl(?:\.m)?|no(?:\.m)?|noboard-chapters|noc|nyc(?:\.m)?|nz(?:\.m)?|office(?:\.m)?|ombuds(?:\.m)?|ombudsmen|ores|otrs-wiki(?:\.m)?|outreach(?:\.m)?|pa-us(?:\.m)?|people|performance|phabricator|pl(?:\.m)?|planet|policy|projectcom|pt(?:\.m)?|punjabi(?:\.m)?|quality(?:\.m)?|research|romd(?:\.m)?|rs(?:\.m)?|rt|ru(?:\.m)?|se(?:\.m)?|schema|searchcom|secure|spcom|species(?:\.m)?|static-bugzilla|steward(?:\.m)?|strategy(?:\.m)?|stream|svn|techblog|techconduct|ticket|toolsadmin|tr(?:\.m)?|transitionteam(?:\.m)?|transparency|ua(?:\.m)?|upload|usability|vote(?:\.m)?|vrt-wiki(?:\.m)?|wb(?:\.m)?|wikimania(?:200[5-9]|201[0-8]|team)?(?:\.m)?|wikitech(?:-static)?|www)\.)?wikimedia\.org$ ${subcookie}example.org;
proxy_cookie_domain  ~(?<subcookie>(wiki(?:books|data|news|pedia|quote|source|versity|voyage)|wiktionary|mediawiki)\.)org$ ${subcookie}example.org;
proxy_cookie_domain  phab.wmfusercontent.org phab.example.org;
proxy_cookie_domain  wma.wmcloud.org wma.example.org;

proxy_hide_header  age;
proxy_hide_header  backend-timing;
proxy_hide_header  content-location;
proxy_hide_header  content-security-policy;
proxy_hide_header  content-security-policy-report-only;
proxy_hide_header  host-header;
proxy_hide_header  link;
proxy_hide_header  mediawiki-cors-rejection;
proxy_hide_header  nel;
proxy_hide_header  p3p;
proxy_hide_header  permissions-policy;
proxy_hide_header  proxy-connection;
proxy_hide_header  referrer-policy;
proxy_hide_header  report-to;
proxy_hide_header  server-timing;
proxy_hide_header  strict-transport-security;
proxy_hide_header  timing-allow-origin;
proxy_hide_header  x-analytics;
proxy_hide_header  x-ats-timestamp;
proxy_hide_header  x-cache;
proxy_hide_header  x-cache-int;
proxy_hide_header  x-cache-status;
proxy_hide_header  x-client-ip;
proxy_hide_header  x-content-security-policy;
proxy_hide_header  x-content-security-policy-report-only;
proxy_hide_header  x-content-type-options;
proxy_hide_header  x-envoy-upstream-service-time;
proxy_hide_header  x-object-meta-sha1base36;
proxy_hide_header  x-powered-by;
proxy_hide_header  x-redirect-by;
proxy_hide_header  x-request-id;
proxy_hide_header  x-resource-location;
proxy_hide_header  x-rq;
proxy_hide_header  x-tec-api-origin;
proxy_hide_header  x-tec-api-root;
proxy_hide_header  x-tec-api-version;
proxy_hide_header  x-timestamp;
proxy_hide_header  x-trans-id;
proxy_hide_header  x-varnish;
proxy_hide_header  x-vector-backend-object;
proxy_hide_header  x-webkit-csp;
proxy_hide_header  x-webkit-csp-report-only;
proxy_hide_header  x-xss-protection;
proxy_hide_header  xkey;

proxy_pass_header  server;

proxy_redirect  https://www.m.mediawiki.org/ https://m.mediawiki.example.org/;
proxy_redirect  https://www.m.wikidata.org/ https://m.wikidata.example.org/;
proxy_redirect  ~^https?:\/\/(m\.)?wikisource\.org(\/?(?:\S*?))$ https://$1wikisource.example.org$2;
proxy_redirect  ~^https?:\/\/(advisors(?:\.m)?|advisory(?:\.m)?|affcom|am(?:\.m)?|analytics|annual|api(?:\.m)?|ar(?:\.m)?|auditcom|bd(?:\.m)?|be(?:\.m)?|blog|board|boardgovcom|br(?:\.m)?|bugzilla|ca(?:\.m)?|chair|checkuser(?:\.m)?|cn(?:\.m)?|co(?:\.m)?|collab|(?:test-)?commons(?:\.m)?|config-master|cxserver|dbtree|design|developer|diff|dk(?:\.m)?|doc|ec(?:\.m)?|ee(?:\.m)?|electcom(?:\.m)?|etherpad|exec(?:\.m)?|fdc(?:\.m)?|fi(?:\.m)?|foundation(?:\.m)?|ge(?:\.m)?|gerrit|gitlab|gr(?:\.m)?|grafana|grants(?:\.m)?|graphite|hi(?:\.m)?|horizon|id(?:\.m)?|id-internal(?:\.m)?|idp|iegcom(?:\.m)?|il|incubator(?:\.m)?|intake-(?:analytics|logging)|integration|internal|labtestwikitech|legalteam(?:\.m)?|lists|login(?:\.m)?|logstash|mai(?:\.m)?|maps|meta(?:\.m)?|mk(?:\.m)?|movementroles|mx(?:\.m)?|ng(?:\.m)?|nl(?:\.m)?|no(?:\.m)?|noboard-chapters|noc|nyc(?:\.m)?|nz(?:\.m)?|office(?:\.m)?|ombuds(?:\.m)?|ombudsmen|ores|otrs-wiki(?:\.m)?|outreach(?:\.m)?|pa-us(?:\.m)?|people|performance|phabricator|piwik|pl(?:\.m)?|planet|policy|projectcom|pt(?:\.m)?|punjabi(?:\.m)?|quality(?:\.m)?|research|romd(?:\.m)?|rs(?:\.m)?|rt|ru(?:\.m)?|se(?:\.m)?|schema|searchcom|secure|spcom|species(?:\.m)?|static-bugzilla|steward(?:\.m)?|strategy(?:\.m)?|stream|svn|techblog|techconduct|ticket|toolsadmin|tr(?:\.m)?|transitionteam(?:\.m)?|transparency|ua(?:\.m)?|upload|usability|vote(?:\.m)?|vrt-wiki(?:\.m)?|wb(?:\.m)?|wikimania(?:200[5-9]|201[0-8]|team)?(?:\.m)?|wikitech(?:-static)?|www)\.wikimedia\.org(\/?(?:\S*?))$ https://$1.example.org$2;
proxy_redirect  https://$subdomain.wikibooks.org/ https://$subdomain.wikibooks.example.org/;
proxy_redirect  https://$subdomain.m.wikibooks.org/ https://$subdomain.m.wikibooks.example.org/;
proxy_redirect  https://$subdomain.wikidata.org/ https://$subdomain.wikidata.example.org/;
proxy_redirect  https://$subdomain.m.wikidata.org/ https://$subdomain.m.wikidata.example.org/;
proxy_redirect  https://$subdomain.wikinews.org/ https://$subdomain.wikinews.example.org/;
proxy_redirect  https://$subdomain.m.wikinews.org/ https://$subdomain.m.wikinews.example.org/;
proxy_redirect  https://$subdomain.wikipedia.org/ https://$subdomain.wikipedia.example.org/;
proxy_redirect  https://$subdomain.m.wikipedia.org/ https://$subdomain.m.wikipedia.example.org/;
proxy_redirect  https://$subdomain.wikiquote.org/ https://$subdomain.wikiquote.example.org/;
proxy_redirect  https://$subdomain.m.wikiquote.org/ https://$subdomain.m.wikiquote.example.org/;
proxy_redirect  https://$subdomain.wikisource.org/ https://$subdomain.wikisource.example.org/;
proxy_redirect  https://$subdomain.m.wikisource.org/ https://$subdomain.m.wikisource.example.org/;
proxy_redirect  https://$subdomain.wiktionary.org/ https://$subdomain.wiktionary.example.org/;
proxy_redirect  https://$subdomain.m.wiktionary.org/ https://$subdomain.m.wiktionary.example.org/;
proxy_redirect  https://$subdomain.wikiversity.org/ https://$subdomain.wikiversity.example.org/;
proxy_redirect  https://$subdomain.m.wikiversity.org/ https://$subdomain.m.wikiversity.example.org/;
proxy_redirect  https://$subdomain.wikivoyage.org/ https://$subdomain.wikivoyage.example.org/;
proxy_redirect  https://$subdomain.m.wikivoyage.org/ https://$subdomain.m.wikivoyage.example.org/;
proxy_redirect  https://$subdomain.mediawiki.org/ https://$subdomain.mediawiki.example.org/;
proxy_redirect  https://$subdomain.planet.wikimedia.org/ https://$subdomain.planet.example.org/;
proxy_redirect  ~^https?:\/\/([0-9a-z-][^.]+)\.planet\.wikimedia\.org(\/?(?:\S*?))$ https://$1.planet.example.org$2;
proxy_redirect  ~^https?:\/\/([0-9a-z-][^.]*(?:\.m)?)\.(wiki(?:books|data|news|pedia|quote|source|versity|voyage)|wiktionary|mediawiki)\.org(\/?(?:\S*?))$ https://$1.$2.example.org$3;

proxy_set_header  Accept $http_accept;
proxy_set_header  Accept-Language $http_accept_language;
proxy_set_header  User-Agent $http_user_agent;
proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header  X-Forwarded-Proto https;
proxy_set_header  X-Real-IP $remote_addr;

proxy_ssl_server_name  on;